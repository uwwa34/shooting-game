<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0,
                 user-scalable=no, viewport-fit=cover" />
  <title>Shooting Game</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      width: 100%; height: 100%;
      background: #000;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      overflow: hidden;
      touch-action: none;       /* block browser scroll / zoom */
    }

    #wrapper {
      position: relative;
      /* scale to fit viewport height, keep 390:720 ratio */
      width: 390px;
      height: 720px;
      transform-origin: top center;
    }

    canvas {
      display: block;
      width: 390px;
      height: 720px;
      image-rendering: pixelated;
    }

    /* ── Loading screen ── */
    #loading {
      position: absolute; inset: 0;
      background: #03050f;
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      color: #00dcf0;
      font-family: 'Courier New', monospace;
      font-size: 18px;
      gap: 16px;
      z-index: 10;
    }
    #loading-bar-bg {
      width: 240px; height: 10px;
      background: #0a1820;
      border-radius: 5px;
      border: 1px solid #0070a0;
    }
    #loading-bar {
      height: 100%; width: 0%;
      background: #00dcf0;
      border-radius: 5px;
      transition: width 0.1s;
    }
    #loading-msg { font-size: 13px; color: #006080; }
  </style>
</head>
<body>

<div id="wrapper">
  <canvas id="gameCanvas" width="390" height="720"></canvas>

  <div id="loading">
    <div>LOADING...</div>
    <div id="loading-bar-bg"><div id="loading-bar"></div></div>
    <div id="loading-msg">Loading assets...</div>
  </div>
</div>

<!--  ════ Scripts — load order matters ════  -->
<script src="js/settings.js"></script>
<script src="js/Character/player.js"></script>
<script src="js/Character/enemy.js"></script>
<script src="js/Character/boss.js"></script>
<script src="js/Character/items.js"></script>
<script src="js/joypad.js"></script>
<script src="js/ranking.js"></script>
<script src="js/game.js"></script>

<script>
// ════════════════════════════════════════════════════
//  Asset Loader  — loads all images & sounds, then starts game
// ════════════════════════════════════════════════════

(function () {
  // Scale canvas wrapper to fit screen
  function fitScreen() {
    const wrapper = document.getElementById('wrapper');
    const scaleX  = window.innerWidth  / 390;
    const scaleY  = window.innerHeight / 720;
    const scale   = Math.min(scaleX, scaleY);
    wrapper.style.transform = `scale(${scale})`;
    // centre horizontally
    wrapper.style.marginLeft = `${(window.innerWidth - 390 * scale) / 2}px`;
  }
  fitScreen();
  window.addEventListener('resize', fitScreen);

  // ── image list ──────────────────────────────────
  const imageFiles = {
    player      : IMG.PLAYER,
    enemy       : IMG.ENEMY,
    boss        : IMG.BOSS,
    friend      : IMG.FRIEND,
    bg          : IMG.BG,
    bullet      : IMG.BULLET,         // กระสุนผู้เล่น
    itemLife    : IMG.ITEM_LIFE,
    itemShield  : IMG.ITEM_SHIELD,
    itemSpecial : IMG.ITEM_SPECIAL,   // เปลี่ยนจาก bomb
    itemWeapon  : IMG.ITEM_WEAPON,
  };

  // ── sound list ──────────────────────────────────
  const soundFiles = {
    bgm     : SND.BGM,
    shoot   : SND.SHOOT,
    hit     : SND.HIT,
    item    : SND.ITEM,
    bShoot  : SND.B_SHOOT,
    explode : SND.EXPLODE,
    win     : SND.WIN,
  };

  const total   = Object.keys(imageFiles).length + Object.keys(soundFiles).length;
  let   loaded  = 0;

  const barEl = document.getElementById('loading-bar');
  const msgEl = document.getElementById('loading-msg');

  function tick(name) {
    loaded++;
    msgEl.textContent = `Loaded: ${name}`;
    barEl.style.width = `${(loaded / total) * 100}%`;
    if (loaded >= total) startGame();
  }

  // ── Load images ─────────────────────────────────
  const images = {};
  for (const [key, src] of Object.entries(imageFiles)) {
    const img = new Image();
    img.onload  = () => tick(key);
    img.onerror = () => { console.warn(`Missing image: ${src}`); tick(key); };
    img.src     = src;
    images[key] = img;
  }

  // ── Load sounds ─────────────────────────────────
  const sounds = {};
  for (const [key, src] of Object.entries(soundFiles)) {
    const audio = new Audio();
    audio.addEventListener('canplaythrough', () => tick(key), { once: true });
    audio.addEventListener('error',          () => { console.warn(`Missing sound: ${src}`); tick(key); }, { once: true });
    audio.src   = src;
    audio.load();
    sounds[key] = audio;
  }

  // ── Kick off game ────────────────────────────────
  function startGame() {
    document.getElementById('loading').style.display = 'none';
    const canvas = document.getElementById('gameCanvas');

    // iOS: resume AudioContext และ BGM pending ทันทีที่ user แตะครั้งแรก
    function unlockAudio() {
      // resume Web Audio API context ถ้ามี
      if (window.AudioContext || window.webkitAudioContext) {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (!unlockAudio._ctx) {
          unlockAudio._ctx = new AC();
          unlockAudio._ctx.resume().catch(() => {});
        }
      }
      // resume BGM ถ้า pending
      if (game && game._resumeBGMIfPending) game._resumeBGMIfPending();
    }
    document.addEventListener('touchstart', unlockAudio, { passive: true });
    document.addEventListener('mousedown',  unlockAudio);

    const game = new Game(canvas, images, sounds);
    game.start();
  }
})();
</script>

</body>
</html>
